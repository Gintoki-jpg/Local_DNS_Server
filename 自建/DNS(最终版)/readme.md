- [1. 系统的功能设计](#1-系统的功能设计)
  - [1.1. 功能概述](#11-功能概述)
  - [1.2. 功能分析和设计](#12-功能分析和设计)
    - [1.2.1. DNS报文构成](#121-dns报文构成)
      - [1.2.1.1. `Header`报头字段格式](#1211-header报头字段格式)
      - [1.2.1.2. `Question`字段格式](#1212-question字段格式)
      - [1.2.1.3. 资源记录字段格式](#1213-资源记录字段格式)
    - [1.2.2. 主要功能](#122-主要功能)
      - [1.2.2.1. DNS服务功能](#1221-dns服务功能)
      - [1.2.2.2. DNS中继服务功能](#1222-dns中继服务功能)
      - [1.2.2.3. DNS屏蔽功能](#1223-dns屏蔽功能)
- [2. 模块划分和软件流程图](#2-模块划分和软件流程图)
  - [2.1. 调试信息模块](#21-调试信息模块)
  - [2.2. DNS包解析模块](#22-dns包解析模块)
    - [2.2.1. 处理请求报](#221-处理请求报)
      - [2.2.1.1. 不良网站屏蔽功能](#2211-不良网站屏蔽功能)
      - [2.2.1.2. 服务器功能](#2212-服务器功能)
      - [2.2.1.3. 中继功能](#2213-中继功能)
    - [2.2.2. 处理响应报](#222-处理响应报)
  - [2.3. 多客户端并发：报头ID转换模块](#23-多客户端并发报头id转换模块)
    - [2.3.1. Server ID Pool](#231-server-id-pool)
    - [2.3.2. 分配方法](#232-分配方法)
    - [2.3.3. 转换方法](#233-转换方法)
  - [2.4. 域名-IP表存储和查找模块](#24-域名-ip表存储和查找模块)
    - [2.4.1. Trie](#241-trie)
    - [2.4.2. Cache](#242-cache)
    - [2.4.3. 静态表](#243-静态表)
  - [2.5. 超时处理](#25-超时处理)
  - [2.6. Windows/Linux源程序的一致性能](#26-windowslinux源程序的一致性能)
- [3. 测试用例及运行结果](#3-测试用例及运行结果)
  - [3.1. 编译](#31-编译)
    - [3.1.1. Windows下编译](#311-windows下编译)
    - [3.1.2. Linux下编译](#312-linux下编译)
  - [3.2. 运行](#32-运行)
- [4. 调试中遇到或解决的问题](#4-调试中遇到或解决的问题)
- [5. 总结和心得体会](#5-总结和心得体会)
- [6. 参考](#6-参考)

# 1. 系统的功能设计

## 1.1. 功能概述

DNS（Domain Name System，域名系统），因特网上作为域名和IP地址互相映射的一个分布式数据库，能够使用户更方便的访问互联网，而不用去记住能够被机器直接读取的IP数串。通过主机名，最终得到该主机对应的IP地址的过程叫做域名解析（或主机名解析）。DNS协议运行在UDP协议之上，使用端口号53。

对于每一级域名长度的限制是63个字符，域名总长度则不能超过253个字符。

本次课程设计要求实现一个DNS中继服务器，读入“域名-IP地址”对照表，当客户端查询域名对应的IP地址时，用域名检索该对照表，三种检索结果：

- 检索结果为ip地址0.0.0.0，则向客户端返回“域名不存在”的报错消息，而不是返回IP地址为0.0.0.0（不良网站拦截功能）
- 检索结果为普通IP地址，则向客户返回这个地址（服务器功能）
- 表中未检到该域名，则向因特网DNS服务器发出查询，并将结果返给客户端（中继功能）

## 1.2. 功能分析和设计

### 1.2.1. DNS报文构成

根据RFC1035，DNS报文构成如下：

```
+---------------------+
|        Header       |
+---------------------+
|       Question      | the question for the name server 
+---------------------+
|        Answer       | RRs answering the question
+---------------------+
|      Authority      | RRs pointing toward an authority 
+---------------------+
|      Additional     | RRs holding additional information 
+---------------------+
```

#### 1.2.1.1. `Header`报头字段格式

```
                                1  1  1  1  1  1
  0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                      ID                       |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|QR|   Opcode  |AA|TC|RD|RA|   Z    |   RCODE   |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    QDCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ANCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    NSCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ARCOUNT                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

ID: 由客户程序设置并由服务器返回结果。客户程序通过它来确定响应与查询是否匹配

QR: 0表示查询报，1表示响应报。

OPCODE: 通常值为0（标准查询），其他值为1（反向查询）和2（服务器状态请求）。

AA: 权威答案(Authoritative answer)

TC: 截断的(Truncated)应答的总长度超512字节时，只返回前512个字节

RD: 期望递归(Recursion desired)查询报中设置，响应报中返回。告诉名字服务器处理递归查询。如果该位为0，且被请求的名字服务器没有一个权威回答，就返回一个能解答该查询的其他名字服务器列表，这称为迭代查询

RA: 递归可用(Recursion Available)如果名字服务器支持递归查询，则在响应中该比特置为1。

Z: 必须为0，保留字段

RCODE: 响应码(Response coded)，仅用于响应报。值为0(没有差错)，值为3表示名字差错。从权威名字服务器返回，表示在查询中指定域名不存在

QDCOUNT: 问题字段数

ANCOUNT: 回答记录字段数

NSCOUNT: 权威记录字段数

ARCOUNT: 附加记录字段数

#### 1.2.1.2. `Question`字段格式

```
                                1  1  1  1  1  1
  0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                                               |
/                     QNAME                     /
/                                               /
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                     QTYPE                     |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                     QCLASS                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

QNAME: 域名，例如`www.bupt.edu.cn`

QTYPE: 请求类型，例如`A(1)`、`MX(15)`、`CNAME(5)`、`PTR(12)`

QCLASS: 请求类别，例如`IN(1)`

#### 1.2.1.3. 资源记录字段格式

回答记录、权威记录、附加记录格式遵循资源记录字段格式，如下

```
                                1  1  1  1  1  1
  0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                                               |
/                                               /
/                      NAME                     /
|                                               |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                      TYPE                     |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                     CLASS                     |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                      TTL                      |
|                                               |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                   RDLENGTH                    |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--|
/                     RDATA                     /
/                                               /
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

NAME: 名字

TYPE: RR的类型码，例如`A(1)`、`MX(15)`、`CNAME(5)`、`PTR(12)`

CLASS: 通常为`IN(1)`，指Internet数据

TTL: 客户程序保留该资源记录的秒数，稳定的资源记录生存时间值可以为2天，它确定了客户端DNS cache可以缓存该记录多长时间

RDLENGTH: 资源数据长度。说明资源数据的字节数，对类型1（TYPE A记录）资源数据是4字节的IP地址

RDATA: 资源数据

### 1.2.2. 主要功能

#### 1.2.2.1. DNS服务功能

将计算机的DNS服务器地址指向本机，当用户通过域名查询ip时，DNS服务器就从本地储存的域名-ip映射表和高速缓存（Cache）中进行查询，将查询到的IP地址返回给用户，从而通过IP地址进行网页访问。

#### 1.2.2.2. DNS中继服务功能

当本地DNS服务器的域名-IP对照表中没有存储所需转换的域名是，就向外部DNS服务器发出查询请求，并将查询到的结果返回给客户端，同时加入到本地服务器的cache中便于下次查找使用。

#### 1.2.2.3. DNS屏蔽功能

当检索对照表得到ip地址为0.0.0.0时，将返回信息的`RCODE`设置为Name Error(1)，表示域名不存在，并求ANCOUNT设置为0，表示没有回答。

# 2. 模块划分和软件流程图

![软件整体流程图](pic/1.svg)

## 2.1. 调试信息模块

我们设置了功能完善的参数：

```
Usage:  dnsrelay [-i] [-d] [-h] [-s <dns-server>] [-f <db-file>]
        -d                     (输出调试信息)
        -h                     (帮助)
        -s dns-server          (指定DNS服务器)
        -f db-file             (指定DNS配置表)      
```

## 2.2. DNS包解析模块

从socket接收报文并处理报头。若QR字段为0，报文为请求报，否则为响应报。

### 2.2.1. 处理请求报

客户端发来请求报，中继从Cache和静态表中依次查找域名对应的IP地址和TTL。若命中Cache，则将查找到的IP地址和TTL封装到一个A类型的资源记录中，附在请求报的尾部，并修改报头相关字段生成响应报，并回发给客户端。

若没有命中Cache，则从由TXT文件导入的静态表中查找：

#### 2.2.1.1. 不良网站屏蔽功能

若静态表中域名对应的IP地址为`0.0.0.0`，则直接将`RCODE`字段置为3并回发，表示域名不存在。

#### 2.2.1.2. 服务器功能

若静态表中查找到对应的IP，将查找到的IP地址封装到一个A类型的资源记录中，附在请求报的尾部，并修改报头相关字段生成响应报，并回发给客户端。

#### 2.2.1.3. 中继功能

若请求也没有命中静态表，则将客户端请求报报头的ID进行转换，获得一个对应的Server ID，并将请求报报头ID字段改成这个对应的Server ID，再转发给公共DNS服务器。

### 2.2.2. 处理响应报

公共DNS服务器发来响应报，若回答字段的资源记录中含有A记录，则将响应报中域名和它对应的IP地址、TTL加入到Cache中。然后将响应报报头中的Server ID转换成对应的客户端ID，再转发给对应的客户端。

## 2.3. 多客户端并发：报头ID转换模块

### 2.3.1. Server ID Pool

报头ID的转换由一个看作ID资源池的数组来实现，数组的大小为65536，每个数组下标看作客户端争用的ServerID资源。数组每个元素有以下字段：

- `hold`: 表示当前资源是否被分配
- `clientIP`: 占用当前资源的客户端IP
- `clientPort`: 占用当前资源的进程端口
- `clientID`: 占用当前资源的客户端报头ID
- `inTime`: 资源分配时间

### 2.3.2. 分配方法

一个`nowId`变量遍历资源池，若当前资源未被分配，或资源不是近期分配的，则将这一资源分配给客户端，并记录使用这个资源的客户端IP、端口、客户端报文报头ID和分配时间。

### 2.3.3. 转换方法

直接返回数组中下标为ServerID的元素对应的ClientID。同时获得报文应该发送的客户端IP和端口。

## 2.4. 域名-IP表存储和查找模块

### 2.4.1. Trie

Trie（字典树）来实现域名到对应IP和TTL记录的映射。

Trie的基本思想是构造一棵树，从根结点出发，依次以字符串中的字符为下标在书的结点进行转移，直到字符串读完，停在的结点即为字符串所对应的索引。我们可以将索引指向Cache或静态表中的记录。

![Trie](https://upload.wikimedia.org/wikipedia/commons/b/be/Trie_example.svg)

### 2.4.2. Cache

Cache由双向链表来实现一个队列（FIFO+LRU）来实现，缓存从公共DNS服务器学习到的域名-IP记录。双向链表参照Linux内核中`list.h`的数据结构。

![list_head](pic/list.svg)

Cache的增删查：

- 增：添加到队列头部，O(1)
- 删：在查找过程中，若记录的TTL过期，则将其从链表中删除，O(1)
- 查：从队列头部开始一次查找，若域名匹配，则返回链表节点的记录数据，若遍历完毕队列没有找到匹配的结点，则返回没有命中，时间复杂度最坏为O(n)，n为Cache大小，但同时可以完成删除过期记录的操作

### 2.4.3. 静态表

txt文件中的静态表直接存在Trie树中，每一个域名的索引指向一个IP地址的记录。

## 2.5. 超时处理

由于UDP的不可靠性，考虑求助外部DNS服务器（中继）却不能得到应答或者收到迟到应答的情形。对于这种情况，程序在按照上述设计工作之外不需要做额外处理，原因是若外部DNS服务器（中继）不能得到应答或者收到迟到应答有以下可能：

- 外部DNS服务器没有返回响应报：这种情况下客户端会自动超时，而对应的ServerID也会因为超时而重新分配，不会造成ServerID资源的浪费。
- 外部DNS服务器没有收到请求报：会导致第一种情况，与第一种情况相同
- 迟到应答：若应答迟到，中继会正常转发给客户端，但客户端已经触发超时，无法处理迟到的响应报，则会直接将其丢弃。

## 2.6. Windows/Linux源程序的一致性能

使用条件编译将Windows和Linux的头文件、宏定义、函数等统一名字。例如在`dnsrelay.h`中：

```c++
#ifdef _WIN32 // 条件分支1
#include <WinSock2.h>

WSADATA wsaData;
SOCKET Sock;
#elif __linux__ // 条件分支2
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/ip.h>
#include <arpa/inet.h>

#define closesocket(socketfd) close(socketfd)

static int Sock;
#endif
```

如果在Windows平台上编译，将保留第一个条件分支；如果在Linux平台上编译，将保留第二个条件分支。

# 3. 测试用例及运行结果

## 3.1. 编译

### 3.1.1. Windows下编译

```
mingw32-make wclean
mingw32-make win
```

### 3.1.2. Linux下编译

```
make clean
make
```

## 3.2. 运行

以Windows为例，将本机DNS服务器设为127.0.0.1。控制台输入`.\dnsrelay.exe -d`（Ubuntu下需要在`sudo`下运行）。使用浏览器能正常访问网页（中继功能），并在控制台输出日志。

![中继功能](pic/2021-06-07_172030.png)

![不良网站屏蔽](pic/2021-06-07_172335.png)

![服务器功能](pic/2021-06-07_172422.png)

# 4. 调试中遇到或解决的问题

调试中，有时Socket通信会出现问题，且用常规调试方法难以定位问题所在。Windows中提供了`WSAGetLastError`函数可以来获取Windows套接字产生的最后一个错误代码，我在遇到套接字相关的问题时，将错误代码输出，并在MSDN中的[Windows 套接字错误代码](https://docs.microsoft.com/zh-cn/windows/win32/winsock/windows-sockets-error-codes-2)文档查看错误代码对应的描述，从而快速准确定位问题，快速解决网络相关的程序漏洞。

在Linux中，我们可以通过输出`strerror(errno)`（需要包含头文件`#include <errno.h>`），来获取最后发生错误的错误代码和描述信息。

# 5. 总结和心得体会

通过此次课程设计，我对网络编程有了较深的理解和完整的程序实现，对于UDP、Socket和DNS有了具体的印象。掌握了更多通用的网络编程专用的调试技巧，对于C语言的指针、结构体的数据对齐、Windows/Linux平台兼容开发都有了进一步的理解，加深了对相关数据结构具体应用场景的认识。

# 6. 参考

1. 计算机网络 7.1 DNS
2. 深入了解计算机系统 第11章 网络编程
3. RFC1034 1035
4. [Windows 开发人员文档](https://docs.microsoft.com/zh-cn/windows/apps/)
5. [Linux manual page](https://man7.org/index.html)
